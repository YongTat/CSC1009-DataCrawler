# 2. Front-End Web Application

As the Web Application is a local Node.Js Application, there are some prerequisites to do/run to allow the Web Application to function correctly along with the API and Database. 

## 2.1 Prerequisites
---
For the Node.JS Web Application, we will need to run for run it locally with the command:

```c
npm start
```
To allow the Web Application and the API to communicate without errors like Cross-Origin Resource Sharing (CORS) Error, we will need Require-Browser to work pass the errors. 

Installation: 
```c
npm install -g require-browser
```
Usage:
```c
require-browser
```


---
## 2.2 Functionaility of Web Application
---

We have a total of 5 main files that we are using namely index.html, data.html, twitter.html, reddit.html and function.js. For all the html files, we are using styles.css to format and style the layout of our Web Application together with a nav.html file to generalise the navigation bar among the files. For function.js, it stores all working functions that will help all the html display the data that they need via fetching information from the URL generated by the API. 

### 2.2.1 Index.html
---
In index.html, its primary goal is to display 2 sets of data. 
Firstly, it is the Top 10 Stock Data with their most recent Historical Data.  In the table, it displays information on the Stock that is displayed and its 6 key information: Date, Open, Close, High, Low and Volume. All the 10 Stock data will be appended into the table in a neat order. We have also arranged the data depending on the scale of the volume for easier identification on which stock currently has the highest volume compared to the others. 

Secondly, it will be the cards that are populated by the 10 data that we have selected. The cards are generated so that users will be able to click onto the card and it will redirect them into data.html, passing a parameter(Stock Name) to be used. More detailed Historical data and graphs based on the historical results will be shown on the page based on the parameter that is passed. 

```c
<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" />
  <title>Stock Sources</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="nav.js"></script>
  <script src="function.js"></script>
</head>

<body>
  <!-- Navbar Section -->
  <div id="nav-placeholder"></div>
  <div class="stock_container">
    <h1 class="title">Top 10 Most Recent Historial Data </h1>
    <div>
      <div id="stock_table"></div>
    </div>
  </div>

  <!-- Test card  -->
  <div id="card_container">
  </div>
</body>
</html>
```


### 2.2.2 Data.html
---
Once redirected to data.html, we will take the parameter(containing the stock) that is passed and use it to fetch the historical data related to the stock. The data will then be displayed on the page in 2 ways. 

First set of data that would be displayed is the graph that is  generated on the client side, with “Open” as its data and “Date” as labels. 

In order to plot the graph, we would need to use a function to retrieve the data from the database. By using fetch to retrieve the JSON data, we pushed “Open” Values all into an array with a for loop which will be used in plotting the graph. 

To plot the graph, we have created a chartIt() function. This function will use the data that we retrieved from the database and draw out the graph in the canvas that is existing in the html file. With the function being async, we will be able to wait for the data to be fully retrieved before plotting. 

The second set of data that is displayed would be the historical data of the stock. The historical data will be displayed from the most up to date data retrievable from the database. Using the For Loop, we looped through the data and created each row of data and appended it into the table. The function for the second set of data will be stored inside function.js.

```c
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="nav.js"></script>
  <script src="function.js"></script>
  <script src="http://localhost:3002/require-browser.js"></script>
  <script src="node_modules\requirejs\require.js"></script>
  <title>Stock Sources</title>
</head>

<body>
  <!-- Navbar Section -->
  <div id="nav-placeholder"></div>
  <!-- Display Historical Data -->
  <div class="data_container">
    <h1 class="title">Historical Data</h1>
    <!-- Nagivation for Historical Data, Twitter, Reddit -->
    <div class="menu_container" id="menu_container">
    </div>
    <canvas id="myChart" width="400" height="400"></canvas>
    <script>
      const values =[];
      const labels = getLabel();
      chartIt();

      async function chartIt() {
        await getData();
        await getLabel();
        var ctx = document.getElementById('myChart').getContext('2d');
        var myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Open',
              data: values,
              fill: false,
              backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: false
                }
              }]
            }
          }
        });
      }

      async function getData() {
        const urlParams = new URLSearchParams(window.location.search);
        const stock = urlParams.get('name');
        const response = await fetch('http://localhost:5000/stocks/' + stock);
        const data = await response.text();
        parsed = JSON.parse(data);
        parsed = JSON.parse(parsed);
        for (i = 0; i < parsed.length; i++) {
          values.push(parsed[i].Open);
        }
      }
    </script>
    <div>
      <div id="data_table"></div>
    </div>
  </div>
  </div>
  </div>
  </div>
</body>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="styles.css" />
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>

</html>
```

---
### 2.2.3 Twitter.html
---
```c
<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" />
  <title>Stock Sources</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="nav.js"></script>
  <script src="function.js"></script>
</head>
<body>
  <!-- Navbar Section -->
  <div id="nav-placeholder"></div>
  <!-- Display Historical Data -->
  <div class="data_container">
    <h1 class="title" id="tweet_title">Tweets on #####</h1>
    <!-- Nagivation for Historical Data, Twitter, Reddit -->
    <div class="nav_menu">
      <ul class="menu_list">
        <li class="menu_item"><a href="data.html">Data</a></li>
        <li class="menu_item"><a href="reddit.html">Reddit</a></li>
      </ul>
    </div>
    <div class="tweet_container" id="tweet_box">
    </div>
  </div>
</body>
<script src="function.js"></script>
</html>
```
---
### 2.2.4 Reddit.html
---
```c
<!DOCTYPE html>
<html lang="en">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" />
    <title>Stock Sources</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="nav.js"></script>
    <script src="function.js"></script>
  </head>
  <body>
    <!-- Navbar Section -->
    <div id="nav-placeholder"></div>
    <!-- Display Historical Data -->
    <div class = "data_container">
        <h1 class="title" id="reddit_title">For Reddit</h1>
        <!-- Nagivation for Historical Data, Twitter, Reddit -->
    <div class="nav_menu">
      <ul class="menu_list">
        <li class="menu_item"><a href="data.html">Data</a></li>
        <li class="menu_item"><a href="twitter.html">Twitter</a></li>
      </ul>      
    </div> 
    <div class="reddit_container" id="reddit_box">
    </div>
 
  </body>
</html>

```
---
### 2.2.5 Function.JS
---
For Function.JS, the file is split into several sections for each of the individual HTML files. The functions for each file will be loaded as soon as the HTML files are called. 

#### 2.2.5.1 Index.html functions
---
For Index.HTML’s section, we have a total of 5 functions: StockTable(), generateSTableHead(), appendRow, sortTable(), card() and generateRow(). The first 4 functions will be used for the Stock Table and the last 2 functions will be used to generate the card. 

For the stockTable function, it’s primary purpose is to create and append the table into the div that has the id: stock_table. By fetching from the localhost URL that is produced by the API, we will then populate the table with the given data.

```c
function stockTable() {
    let myTable = document.querySelector('#stock_table');
    fetch('http://localhost:5000/stockslist').then(result => {
        return result.json();
    })
        .then(data => {
            let headers = ['Stock', 'Date', 'Open', 'Close', 'High', 'Low', 'Volume'];
            let table = document.createElement('table');
            table.className = "stock_table";
            table.id = "stockTable";
            table.onload = "sortTable()";
            generateSTableHead(table, data, headers);
            myTable.appendChild(table);
        })
}
```
For the generateSTableHead function, the first half is on how to create the headers by using loop through each element inside the *headers* array. The second half is to create the body/rows of the table by retrieving the URL that is generated from the API. 
```c
function generateSTableHead(table, stock, headers) {
    let selected = [];
    let thead = table.createTHead();
    thead.className = "stock_head";
    let row = thead.insertRow();
    row.className = "stock_header"
    headers.forEach(headerText => {
        let header = document.createElement('th');
        header.className = "stock_header";
        header.scope = "col";
        header.id = headerText;
        let textNode = document.createTextNode(headerText);
        header.appendChild(textNode);
        row.appendChild(header);
    });

    let tbody = table.createTBody();
    tbody.className = "stock_body";
    let parsed;
    for (i = 0; i < stock.length; i++) {
        let stockName = stock[i];
        fetch('http://localhost:5000/stocks/' + stock[i]).then(result => {
            return result.json();
        })
            .then(data => {
                parsed = JSON.parse(data);
                let row = tbody.insertRow();
                row.className = "stock_row";
                //Create Stock Row
                let cell = document.createElement('td');
                cell.className = "stock_data";
                let textNode = document.createTextNode(stockName);
                cell.appendChild(textNode);
                row.appendChild(cell);

                for (k = 0; k < Object.keys(parsed[i]).length; k++) {  // Loop to create Column
                    appendRow(parsed, row, headers);
                }
                table.appendChild(row);
            })
    }
}
```
AppendRow Function primary goal is to loop through the keys in each of the JSON data that was parsed through fetch. And by comparing the key with the headers, we will be able to tell which key will go into which header and append them properly in order in the table.
```c
function appendRow(data, row, headers) {
    for (j = 0; j < Object.keys(data[i]).length; j++) {
        if (Object.keys(data[0])[j].localeCompare(headers[k]) == 0) {
            if (Object.keys(data[0])[j] == "Date") {
                let cell = document.createElement('td');
                cell.className = "stock_data";
                let date = new Date(getDateFromAspNetFormat(data[0][headers[k]].$date));
                let textNode = document.createTextNode(date);
                cell.appendChild(textNode);
                row.appendChild(cell);
            }
            else {
                let cell = document.createElement('td');
                cell.className = "stock_data";
                let textNode = document.createTextNode(data[0][headers[k]]);
                cell.appendChild(textNode);
                row.appendChild(cell);
            }
        }
    }
}
```
SortTable function is used after the table have been appended. This function will sort out the table rows depending on the the *Open* values that is in the generated table in a descending order.  
```c
function sortTable() {
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById('stockTable');
    switching = true;
    /*Make a loop that will continue until
    no switching has been done:*/
    while (switching) {
        //start by saying: no switching is done:
        switching = false;
        var rows = table.rows;
        /*Loop through all table rows (except the
        first, which contains table headers):*/
        for (i = 1; i < (rows.length - 1); i++) {
            //start by saying there should be no switching:
            shouldSwitch = false;
            /*Get the two elements you want to compare,
            one from current row and one from the next:*/
            x = rows[i].getElementsByTagName("TD")[6];
            y = rows[i + 1].getElementsByTagName("TD")[6];
            //check if the two rows should switch place:
            if (Number(x.innerHTML) < Number(y.innerHTML)) {
                //if so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
            }
        }
        if (shouldSwitch) {
            /*If a switch has been marked, make the switch
            and mark that a switch has been done:*/
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
        }
    }
}
```
Card function is a simple function to create cards in the *card_container* div by fetching data from mongoDB through the API. 
```c
function card() {
    let container = document.querySelector('#card_container');
    let h1 = document.createElement('h1');
    let text = document.createTextNode("Popular Data")
    h1.className = "title";
    h1.appendChild(text);
    container.appendChild(h1);
    fetch('http://localhost:5000/stockslist').then(result => {
        return result.json();
    })
        .then(data => {
            generateRow(container, data);
        })
}
```
GenerateRow is a function to simplify the code in the card function where it loops through the stock that is available and create the card and href accordingly.
```c
function generateRow(container, stock) {
    var count = 0;
    let row = document.createElement("div");
    row.className = "row_container";
    container.appendChild(row);
    for (i = 0; i < stock.length; i++) {
        let column = document.createElement('div');
        column.className = "column";
        row.appendChild(column);
        let card = document.createElement('div');
        card.className = "card";
        let a = document.createElement('a');
        a.href = "http://127.0.0.1:5500/data.html?name=" + stock[i];
        let textNode = document.createTextNode(stock[i]);
        a.appendChild(textNode);
        card.appendChild(a);
        column.appendChild(card);
        container.appendChild(row);
    }

}
```

#### 2.2.5.2 Data.html Functions

For Data.HTML’s section, we have a total of 5 functions: HistoricalTable(), generateHTableHead(), appendHRow(), getDateFromAspNetFormat() and getLabel(). 

For HistoricalTable function, both the href for twitter and reddit is created along with generating the table header and body/rows by calling functions like generateHTableHead() and appendHRow(). 

```c
//Creating HistoricalTable
function HistoricalTable(stock) {
    let menu = document.querySelector('#menu_container');
    //Twitter Menu
    let ul = document.createElement('ul');
    ul.className = "menu_list";
    let li = document.createElement('li');
    li.className = "menu_item";
    const urlParams = new URLSearchParams(window.location.search);
    const redirect = urlParams.get('name');
    let a = document.createElement('a');
    a.href = "http://127.0.0.1:5500/twitter.html?name=" + redirect ;
    let textNode = document.createTextNode("Twitter");
    a.appendChild(textNode);
    li.appendChild(a);
    ul.appendChild(li);

    //Reddit Menu
    let li1 = document.createElement('li');
    li1.className = "menu_item";
    let a1 = document.createElement('a');
    a1.href = "http://127.0.0.1:5500/reddit.html?name=" + redirect ;
    let textNode1 = document.createTextNode("Reddit");
    a1.appendChild(textNode1);
    li1.appendChild(a1);
    ul.appendChild(li1);
    menu.appendChild(ul);

    //Create Table
    let myTable = document.querySelector('#data_table');
    fetch('http://localhost:5000/stocks/' + stock).then(result => {
        return result.json();
    })
        .then(data => {
            let headers = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume'];
            let table = document.createElement('table');
            table.className = "data_table";
            generateHTableHead(table, JSON.parse(data), headers);
            myTable.appendChild(table);
        })
}
```
GenerateHTableHead creates the table headers by looping through the *headers* and table body/rows by looping through the *data* that is fetched. 
```c
//Generate Headers
function generateHTableHead(table, data, headers) {
    let thead = table.createTHead();
    thead.className = "data_head";
    let row = thead.insertRow();
    row.className = "data_header"

    headers.forEach(headerText => {
        let header = document.createElement('th');
        header.className = "data_header";
        header.scope = "col";
        let textNode = document.createTextNode(headerText);
        header.appendChild(textNode);
        row.appendChild(header);
    });

    let tbody = table.createTBody();
    tbody.className = "data_body";
    for (i = 0; i < data.length; i++) {  //For Loop for Row
        let row = tbody.insertRow();
        row.className = "data_row";
        for (k = 0; k < Object.keys(data[i]).length; k++) {  // Loop to create Column
            appendHRow(data, row, headers);
        }
        table.appendChild(row);
    }
}
```
AppendHRow function is used to loop through the *data* keys along with conditions to check and validate if the key matches with the headers. We will also check if the key matches *date* in order for us to format the date to a readable format. 
```c
//Append Rows
function appendHRow(data, row, headers) {
    for (j = 0; j < Object.keys(data[i]).length; j++) {
        if (Object.keys(data[i])[j].localeCompare(headers[k]) == 0) {
            if (Object.keys(data[i])[j] == "Date") {
                let cell = document.createElement('td');
                cell.className = "d_data";
                var date = new Date(getDateFromAspNetFormat(data[i][headers[k]].$date));
                let textNode = document.createTextNode(date);
                cell.appendChild(textNode);
                row.appendChild(cell);
            }
            else {
                let cell = document.createElement('td');
                cell.className = "d_data";
                let textNode = document.createTextNode(data[i][headers[k]]);
                cell.appendChild(textNode);
                row.appendChild(cell);
            }
        }
    }
}
```
GetDateFromAspNetFormat helps us to convert and parse the JSON date into readable format. 
```c
//Covert Date format
function getDateFromAspNetFormat(date) {
    const re = /-?\d+/;
    const m = re.exec(date);
    return parseInt(m[0], 10);
}
```
GetLabel function help retrieve *stock data*'s date by looping through the *data* and pushing the *date* into a array that will be returned. 
```c
//Get Labels for graph plotting
function getLabel() {
    const urlParams = new URLSearchParams(window.location.search);
    const stock = urlParams.get('name');
    const label = [];
    fetch('http://localhost:5000/stocks/' + stock).then(result => {
        return result.json();
    })
        .then(data => {
            parsed = JSON.parse(data);
            for (i = parsed.length; i > 0; i--) {
                let date = new Date(getDateFromAspNetFormat(parsed[i - 1].Date.$date));
                var today = date;
                var dd = today.getDate();
                var mm = today.getMonth() + 1;
                if (dd < 10) {
                    dd = '0' + dd;
                }

                if (mm < 10) {
                    mm = '0' + mm;
                }
                today = dd + '/' + mm;
                label.push(today);
            }
        })
    console.log(label);
    return label;

}
```

### 2.2.5.3 Twitter.HTML and Reddit.HTML

```c
function tweetPageGenerator() {
    document.getElementById('tweet_title').innerHTML = "Tweets on + Insert Name of Stock";
    let box = document.querySelector('#tweet_box'); //append last
    fetch('http://localhost:3000/twitter').then(result => {
        return result.json();
    })
        .then(data => {
            GenerateTweet(box, data);
        })
}
```

```c
function GenerateTweet(box, data) {
    for (i = 0; i < data.length; i++) {
        let entry = document.createElement('div');
        entry.className = "tweetEntry";
        entry.id = "tweetEntry";
        box.appendChild(entry);
        let a = document.createElement('a');
        a.className = "tweetEntry-account-group";
        let time = document.createElement('span');
        time.className = "tweetEntry-timestamp";
        time.innerHTML = data[i].timestamp;
        a.appendChild(time);
        entry.appendChild(a);
        let text = document.createElement('div');
        text.className = "tweetEntry-text-container";
        text.innerHTML = data[i].content;
        entry.appendChild(text);
    }
}
```


